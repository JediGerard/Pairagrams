<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login / Register</title>
  <style>
    /* === Base reset & font === */
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      background: #fff;
      display: flex;
      justify-content: center;
      align-items: start;
      min-height: 100vh;
      padding: 2rem;
      color: #000;
    }

    /* === Container === */
    .login-container {
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    /* === Heading === */
    .login-container h1 {
      font-size: 2.5rem;
      margin-bottom: 1.5rem;
    }

    /* === Google sign-in link === */
    .google-login {
      display: inline-flex;
      align-items: center;
      text-decoration: underline;
      color: #000;
      font-size: 1.1rem;
      margin-bottom: 2rem;
    }
    .google-login img {
      width: 24px;
      height: 24px;
      margin-right: 0.5rem;
    }

    /* === Form fields === */
    .login-form input {
      width: 100%;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }

    /* === Buttons === */
    .btn {
      display: block;
      width: 100%;
      padding: 0.75rem 0;
      margin-bottom: 1rem;
      border: none;
      border-radius: 9999px;
      font-size: 1.25rem;
      font-weight: 500;
      cursor: pointer;
    }
    .btn-login {
      background-color: #e91e63; /* pink */
      color: #fff;
    }
    .btn-register {
      background-color: #4caf50; /* green */
      color: #fff;
    }

    /* === Guest link === */
    .guest-link {
      display: inline-block;
      color: #000;
      text-decoration: underline;
      font-size: 1rem;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <h1>Login / Register</h1>

    <a href="#" id="google-btn" class="google-login">
  <img src="assets/google_G_logo.png" alt="Google logo">
  Sign in with Google
</a>

    <!-- Email / password / username fields -->
    <form class="login-form">
      <input type="email"   id="email"    placeholder="Enter your email"           required>
      <input type="password" id="password" placeholder="Create a strong password"    required>
      <input type="text"     id="username" placeholder="Choose a username"          required>

      <!-- Action buttons -->
      <button type="button" id="login-btn"    class="btn btn-login">Login</button>
      <button type="button" id="register-btn" class="btn btn-register">Register</button>

      <!-- Continue as guest -->
      <a href="daily_puzzle_start.html" class="guest-link">Continue as guest</a>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      sendEmailVerification,
      signInWithPopup,
      GoogleAuthProvider
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyADcjbU1jM9Pqq4ZDrInVGSN7SdUb6O5nA",
      authDomain: "pairagrams.firebaseapp.com",
      projectId: "pairagrams",
      storageBucket: "pairagrams.firebasestorage.app",
      messagingSenderId: "958505224302",
      appId: "1:958505224302:web:81bae163e8a526467afe7f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const usernameInput = document.getElementById("username");

    document.getElementById("register-btn").onclick = async () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      const username = usernameInput.value;

      if (!/^\S+@\S+\.\S+$/.test(email)) return alert("Invalid email.");
      if (!/^(?=.*\d)(?=.*[!@#$%^&*])[A-Za-z\d!@#$%^&*]{8,}$/.test(password))
        return alert("Password must be at least 8 characters with one number and one special character.");

      const usernameRef = doc(db, "usernames", username);
      const usernameSnap = await getDoc(usernameRef);
      if (usernameSnap.exists()) return alert("Username already taken.");

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await sendEmailVerification(userCredential.user);
        await setDoc(doc(db, "users", userCredential.user.uid), {
          email,
          username
        });
        await setDoc(usernameRef, { uid: userCredential.user.uid });
        localStorage.setItem("playerName", username);
        alert("Registered! Check your email for verification.");
        window.location.href = "howtoplay.html";
      } catch (e) {
        alert("Error: " + e.message);
      }
    };

    document.getElementById("login-btn").onclick = async () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const userDoc = await getDoc(doc(db, "users", userCredential.user.uid));
        const username = userDoc.exists() ? userDoc.data().username : "Player";
        localStorage.setItem("playerName", username);
        window.location.href = "howtoplay.html";
      } catch (e) {
        alert("Login failed: " + e.message);
      }
    };

    document.getElementById("google-btn").onclick = async () => {
      try {
        const provider = new GoogleAuthProvider();
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        const userDocRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(userDocRef);

        let username;
        if (!docSnap.exists()) {
          username = generateUsername();
          await setDoc(userDocRef, {
            email: user.email,
            username
          });
          await setDoc(doc(db, "usernames", username), { uid: user.uid });
        } else {
          username = docSnap.data().username;
        }

        localStorage.setItem("playerName", username);
        window.location.href = "howtoplay.html";
      } catch (e) {
        alert("Google sign-in error: " + e.message);
      }
    };

    function generateUsername() {
      const adj = ["Happy", "Bright", "Fast", "Silent", "Lucky"];
      const noun = ["Tiger", "Castle", "Cloud", "Star", "Wizard"];
      const num = Math.floor(Math.random() * 100);
      return `${adj[Math.floor(Math.random() * adj.length)]}${noun[Math.floor(Math.random() * noun.length)]}${num}`;
    }
  </script>
</body>
</html>